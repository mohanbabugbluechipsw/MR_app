@model IEnumerable<Model_New.Models.OutLetMasterDetail>

@{
    ViewData["Title"] = "Review Plane";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@{
    var userName = Context.Session.GetString("UserName");
}

<form asp-action="AddbeforeReview" method="post">
    <div class="container">
        <!-- Form Title -->
        <h3 class="text-center mb-4">After Review Plane</h3>

        <div class="row">
            <!-- mrcode input -->
            <div class="col-md-6 mb-3">
                <label for="mrcodeInput" class="form-label">MR Code:</label>
                <input type="text" id="mrcodeInput" class="form-control" name="mrcode" value="@userName" readonly>
            </div>

            <!-- RSCODE input -->
            <div class="col-md-6 mb-3">
                <label for="rscodeInput" class="form-label">Select RSCODE:</label>
                <input type="text" id="rscodeInput" class="form-control" placeholder="Type RSCODE ..." autocomplete="off">
                <input type="hidden" id="selectedRscode" name="selectedRscode">
                <div id="rscodeSuggestions" class="list-group" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                    <!-- Suggestions will appear here -->
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Outlet input -->
            <div class="col-md-6 mb-3">
                <label for="outletInput" class="form-label">Search Outlet:</label>
                <input type="text" id="outletInput" class="form-control" placeholder="Type to search..." autocomplete="off">
                <input type="hidden" id="selectedOutlet" name="selectedOutlet">
                <div id="outletSuggestions" class="list-group" style="display: none; position: absolute; z-index: 1000; max-height: 200px; overflow-y: auto;">
                    <!-- Suggestions will be dynamically added here -->
                </div>
            </div>
        </div>

        <!-- Hidden Fields to Store RsName and PartyName -->
        <input type="hidden" id="selectedRsName" name="selectedRsName" />
        <input type="hidden" id="selectedPartyName" name="selectedPartyName" />

        <!-- Submit Button -->
        <div class="text-center">
            <button type="submit" class="btn btn-primary btn-lg">Next</button>
        </div>
    </div>
</form>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            // RSCODE input handling
            $('#rscodeInput').on('keyup', function () {
                var searchTerm = $(this).val();

                if (searchTerm.length > 0) {
                    $.ajax({
                        url: '/ReviewPlane/GetRSCodes',
                        type: 'GET',
                        data: { term: searchTerm },
                        success: function (data) {
                            $('#rscodeSuggestions').empty();
                            if (data.length > 0) {
                                $('#rscodeSuggestions').show();
                                data.forEach(function (item) {
                                    $('#rscodeSuggestions').append(
                                        `<a class="list-group-item list-group-item-action" data-id="${item.code}" data-name="${item.name}">
                                                    ${item.code} - ${item.name}
                                                </a>`
                                    );
                                });
                            } else {
                                $('#rscodeSuggestions').hide();
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error fetching RSCODEs:', error);
                        }
                    });
                } else {
                    $('#rscodeSuggestions').hide();
                }
            });

            $(document).on('click', '#rscodeSuggestions .list-group-item', function () {
                var rscode = $(this).data('id');
                var rsname = $(this).data('name');
                $('#rscodeInput').val(`${rscode} - ${rsname}`);
                $('#selectedRscode').val(rscode);
                $('#rscodeSuggestions').hide();
            });

            // Outlet input handling
            $('#outletInput').on('keyup', function () {
                var searchTerm = $(this).val();
                var rscode = $('#selectedRscode').val();

                if (searchTerm.length > 2) {
                    $.ajax({
                        url: '/ReviewPlane/GetOutlets',
                        type: 'GET',
                        data: { term: searchTerm, rscode: rscode },
                        success: function (data) {
                            $('#outletSuggestions').empty();
                            if (data.length > 0) {
                                $('#outletSuggestions').show();
                                data.forEach(function (item) {
                                    $('#outletSuggestions').append(
                                        `<a class="list-group-item list-group-item-action" data-code="${item.code}" data-name="${item.name}">
                                                    ${item.name} (${item.code})
                                                </a>`
                                    );
                                });
                            } else {
                                $('#outletSuggestions').hide();
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error('Error fetching outlets:', error);
                        }
                    });
                } else {
                    $('#outletSuggestions').hide();
                }
            });

            $(document).on('click', '#outletSuggestions .list-group-item', function () {
                var outletName = $(this).data('name');
                var outletCode = $(this).data('code');
                $('#outletInput').val(`${outletName} (${outletCode})`);
                $('#selectedOutlet').val(outletCode);
                $('#outletSuggestions').hide();
            });

            // Hide suggestions when clicking outside
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#rscodeInput, #rscodeSuggestions').length) {
                    $('#rscodeSuggestions').hide();
                }
                if (!$(e.target).closest('#outletInput, #outletSuggestions').length) {
                    $('#outletSuggestions').hide();
                }
            });
        });
    </script>

    <style>
        .list-group-item {
            cursor: pointer;
        }

            .list-group-item:hover {
                background-color: #f0f0f0;
            }

        .form-label {
            font-weight: bold;
            color: #333;
        }

        .form-control {
            border-radius: 0.375rem;
        }

        .btn {
            width: 100%;
            padding: 10px;
            font-size: 16px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .row {
            margin-bottom: 15px;
        }

        .text-center {
            text-align: center;
        }

        @@media (max-width: 767px) {
            .btn {
                font-size: 14px;
                padding: 12px;
            }
        }
    </style>
}
